"""Slack bot entrypoint â€” Modal function definition and ASGI app."""

import modal

from agents.infra import app
from agents.infra.shared import rag_vol
from agents.ml_agent import get_sandbox as _ml_sandbox  # noqa: F401  registers @app.function deps
from agents.rag_agent import get_sandbox as _rag_sandbox  # noqa: F401  registers @app.function deps

slack_secret = modal.Secret.from_name("slack-secret")

slack_bot_image = (
    modal.Image.debian_slim(python_version="3.12")
    .pip_install("slack-bolt", "fastapi")
    .add_local_python_source("agents")
    .add_local_dir("agents/ml_agent/.claude", "/root/agents/ml_agent/.claude")
    .add_local_dir("agents/rag_agent/rag", "/root/agents/rag_agent/rag")
)


@app.function(
    secrets=[slack_secret],
    image=slack_bot_image,
    volumes={"/data": rag_vol},
    scaledown_window=10 * 60,
    min_containers=1,
)
@modal.concurrent(max_inputs=100)
@modal.asgi_app()
def slack_bot():
    from agents.slackbot.bot import SlackBot

    return SlackBot().create_fastapi_app()
